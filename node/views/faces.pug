extends layout

block content
  h1(class="text-2xl font-bold mb-4") Faces

  // Top bar
  .flex.items-center.gap-3.mb-4.relative
    input#personName(
      type="text"
        placeholder="Type a name..."
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
      class="border border-gray-300 rounded px-3 py-2 w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
    )
    ul#searchResults(class="absolute left-0 top-full border border-gray-300 bg-white rounded w-64 mt-1 shadow hidden z-20")
    button#tagBtn(
      class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded"
    ) Tag
    button#ignoreBtn(
      class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded"
    ) Ignore

  .flex.items-center.gap-2.mb-2
    input#showUnassigned(type="checkbox" class="w-4 h-4" checked="true")
    label(for="showUnassigned") Show only unassigned

  hr(class="my-6 border-gray-300")

  // Faces grid
  .faces-grid(
    class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4"
  )
    each face in faces
      .face-box(
        data-id=face.id
        class="relative border border-gray-300 rounded-lg p-2 cursor-pointer hover:bg-gray-50 transition"
      )
        button(
          class="absolute top-1 right-1 bg-red-600 text-white text-xs px-1 rounded ignore-single"
          data-id=face.id
        ) X
        img(
          src=`data:image/jpeg;base64,${face.crop_base64}`
          alt="face"
          class="w-full h-40 object-cover rounded-md"
        )

        if face.person_name
          div(class="text-center text-sm mt-2 font-medium") #{face.person_name}
        else
          div(class="text-center text-sm mt-2 text-gray-500") unassigned

  // Pagination
  if totalPages > 1
    .flex.justify-center.items-center.gap-4.mt-8.mb-12
      if page > 1
        a(
          href=`/faces?page=${page - 1}`
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded"
        ) ← Prev

      span.text-gray-600 Page #{page} / #{totalPages}

      if page < totalPages
        a(
          href=`/faces?page=${page + 1}`
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded"
        ) Next →

  // Toggle logic
  script.
    const toggle = document.getElementById('showUnassigned');

    document.querySelectorAll('.face-box').forEach(box => {
      const assigned = box.querySelector('div').textContent.trim() !== 'unassigned';
      if(assigned) box.classList.add('hidden');
    });

    toggle.addEventListener('change', () => {
      document.querySelectorAll('.face-box').forEach(box => {
        const assigned = box.querySelector('div').textContent.trim() !== 'unassigned';
        if (toggle.checked && assigned) box.classList.add('hidden');
        else box.classList.remove('hidden');
      });
    });

    const selected = new Set();

    document.querySelectorAll('.face-box').forEach(box => {
      box.addEventListener('click', () => {
        const id = box.dataset.id;
        if (selected.has(id)) {
          selected.delete(id);
          box.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50');
        } else {
          selected.add(id);
          box.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50');
        }
      });
    });

    const input = document.getElementById('personName');
    const results = document.getElementById('searchResults');

    input.addEventListener('input', async () => {
      const q = input.value.trim();
      if (!q) {
        results.classList.add('hidden');
        return;
      }

      const r = await fetch(`/api/people/search?name=${encodeURIComponent(q)}`);
      const people = await r.json();

      results.innerHTML = "";

      people.forEach(p => {
        const li = document.createElement("li");
        li.className = "p-2 hover:bg-gray-100 cursor-pointer";
        li.textContent = `${p.name} (ID ${p.id})`;
        li.onclick = () => {
          input.value = p.name;
          input.dataset.personId = p.id;
          results.classList.add("hidden");
        };
        results.appendChild(li);
      });

      const liNew = document.createElement("li");
      liNew.className = "p-2 hover:bg-gray-100 cursor-pointer text-blue-600";
      liNew.textContent = `➕ Create new: ${q}`;
      liNew.onclick = () => {
        input.dataset.personId = "";
        results.classList.add("hidden");
      };
      results.appendChild(liNew);

      results.classList.remove("hidden");
    });

    document.getElementById('tagBtn').addEventListener('click', () => {
      const inputEl = document.getElementById('personName');
      const name = inputEl.value.trim();
      const personId = inputEl.dataset.personId || null;
      if (!name) {
        alert("Enter a name first.");
        return;
      }

      console.log("Would TAG:", name);
      console.log("Faces:", Array.from(selected));
      // backend POST will come later
    });

    document.getElementById('tagBtn').addEventListener('click', async () => {
      const inputEl = document.getElementById('personName');
      const name = inputEl.value.trim();
      const personId = inputEl.dataset.personId || null;
      if (!name) {
        alert("Enter a name first.");
        return;
      }

      const ids = Array.from(selected);

      const res = await fetch("/faces/tag", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, personId, faceIds: ids })
      });

      const out = await res.json();
      console.log(out);

      if (out.success) {
        // alert("Tagged successfully!");
        window.location.reload(); // refresh to show updated labels
      }
    });

    document.getElementById('ignoreBtn').addEventListener('click', async () => {
      const ids = Array.from(selected);
      if (ids.length === 0) {
        alert("Select at least one face to ignore.");
        return;
      }

      const res = await fetch("/faces/ignore", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ faceIds: ids })
      });

      const out = await res.json();
      console.log(out);

      if (out.success) {
        window.location.reload();
      }
    });

    document.querySelectorAll('.ignore-single').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const id = btn.dataset.id;
        const res = await fetch("/faces/ignore", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ faceIds: [id] })
        });
        const out = await res.json();
        if(out.success) window.location.reload();
      });
    });
